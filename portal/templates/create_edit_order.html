{% load staticfiles %}
<!DOCTYPE html>
<html ng-app="CreateEditOrder" lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="shortcut icon" href="{% static "img/favicon.png" %}">
        <title>Create/Edit order | Prometheus</title>
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.1/angular-material.min.css">
        <link rel="stylesheet" href="{% static "css/dashboard.css" %}" type = "text/css">
        <link rel="stylesheet" href="{% static "css/v-accordion.css" %}" type = "text/css">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
        <script type="text/javascript" src = "{% static "js/angular.min.js" %}"></script>
        <script type="text/javascript" src = "{% static "js/angular-animate.js" %}"></script>
        <script type="text/javascript" src = "{% static "js/angular-spinner.min.js" %}"></script>
        <script type="text/javascript" src = "{% static "js/spin.min.js" %}"></script>
        <script type="text/javascript" src = "{% static "js/v-accordion.js" %}"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-aria.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.1/angular-material.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-messages.js""></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.14.1/moment.min.js"></script>

        <script type="text/javascript" src = "{% static "js/utility.js" %}"></script>

        <style type="text/css">
            hr {
                margin-bottom: 5px;
                margin-top: 5px;
            }
            .flex.layout.layout-row {
                padding-bottom: 3px;
            }
            span.flex {
                font-size: large;
                text-align: center;
                border: black;
                border-width: thin;
                border-style: solid;
                align-items: center;
                justify-content: center;
                display: flex;
            }
            button span {
                border-style: none;
            }
            span.no-border {
                border-style: none;
                font-size: 13px;
            }
            section.section {
                padding-top:20px;
                padding-left:20px;
                padding-right:20px;
            }
            div.zones {
                /*padding: 10px;*/
                text-align: inherit;
            }
            span.green {
                background-color: #87e087;
            }
            span.orange {
                background-color: #efaa52;
            }
            span.light_red {
                background-color: #ff8181;
            }
            span.flash_red {
                background-color: #a50000;
                color: antiquewhite;
            }
        </style>

        <script type="text/javascript">
            var app = angular.module('CreateEditOrder',['ngMaterial', 'ngMessages', 'vAccordion', 'ngAnimate', 'shared']).value('ops_user', '{{ops_user}}').value('order_id', '{{order_id}}');
            app.config(['$httpProvider', function($httpProvider) {
                $httpProvider.defaults.xsrfCookieName = 'csrftoken';
                $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
            }])
            .config(['$interpolateProvider', function($interpolateProvider) {
			    $interpolateProvider.startSymbol('[[');
			    $interpolateProvider.endSymbol(']]');
			}])
            .config(['$mdIconProvider', function($mdIconProvider) {
                $mdIconProvider
                   .iconSet('person', 'img/person_pin.svg', 24)
                   .defaultIconSet('img/person_pin.svg', 24);
            }]);

            app.controller('CreateEditOrder', function DashboardCtrl ($scope, $timeout, $q, $http, $window, $mdDialog, $interval, commonUtility, ops_user, order_id) {
                var self = this;

                self.timer = 0;
                self.show_err = false;
                self.order_id = order_id;
                self.user = ops_user;

                self.loadSpinner = false;

                self.redirectToOrderPage = function() {

                };

                self.workTypeChange = function() {
                    $scope.work_sub_types = self.dropdowndata['work_sub_types'];
                    var work_sub_types = [];
                    for (var i = 0; i < $scope.work_sub_types.length; i++) {
                        if ($scope.work_sub_types[i].work_type_id === self.order_data.work_type) {
                            work_sub_types.push($scope.work_sub_types[i]);
                        }
                    }
                    $scope.work_sub_types = work_sub_types;
                    self.order_data.size = null;
                };

                self.shootTypeChange = function() {
                    $scope.shoot_sub_types = self.dropdowndata['shoot_sub_types'];
                    var shoot_sub_types = [];
                    if ([4,5].indexOf(self.order_data.shoot_type) >= 0) {
                        for (var i = 0; i < $scope.shoot_sub_types.length; i++) {
                            if ($scope.shoot_sub_types[i].shoot_type_id === self.order_data.shoot_type) {
                                shoot_sub_types.push($scope.shoot_sub_types[i]);
                            }
                        }
                    }
                    $scope.shoot_sub_types = shoot_sub_types;
                    self.order_data.shoot_sub_type = null;
                };

                self.getOrder = function() {
                    self.order_data = {};
                    if (order_id != "None") {
                    	self.loadSpinner = true;
                        self.message = "";
                        
                        $http({
                            url: "/create_edit_order/get_order?order_id=" + order_id,
                            method: "GET"
                        })
                        .then(function(response){
                            self.show_err = false;
                        	self.loadSpinner = false;
                            var response_data = response.data;
                            self.order_data = response_data["order_data"];
                            self.order_data.incoming_date = new Date(self.order_data.incoming_date);
                            self.getDropDownData();
                        }, function(error_response) {
                            var response_data = error_response.data;
                            commonUtility.displayErrorMsg(response_data["message"]);
                            self.show_err = true;
                            self.loadSpinner = false;
                        });
                    }
                    else {
                        self.getDropDownData();
                    }
                };

                self.getDropDownData = function() {
                	self.loadSpinner = true;
                    self.message = "";
                    
                    $http({
                        url: "/create_edit_order/get_drop_down_data",
                        method: "GET"
                    })
                    .then(function(response){
                        self.show_err = false;
                    	self.loadSpinner = false;
                        var response_data = response.data;
                        self.dropdowndata = response_data["dropdowndata"];
                        $scope.garment_types = self.dropdowndata['garment_types'];
                        $scope.work_types = self.dropdowndata['work_types'];
                        $scope.work_sub_types = self.dropdowndata['work_sub_types'];
                        $scope.shoot_types = self.dropdowndata['shoot_types'];
                        $scope.shoot_sub_types = self.dropdowndata['shoot_sub_types'];
                        $scope.page_qualities = self.dropdowndata['page_qualities'];
                        $scope.binding_types = self.dropdowndata['binding_types'];

                        // Initialise drop downs
                        if (self.order_data) {
                            self.shootTypeChange();
                            self.workTypeChange();                            
                        }
                        
                    }, function(error_response) {
                        var response_data = error_response.data;
                        commonUtility.displayErrorMsg(response_data["message"]);
                        self.show_err = true;
                        self.loadSpinner = false;
                    });
                };

                $scope.submitForm = function() {
                    self.loadSpinner = true;
                    self.message = "";
                    
                    $http({
                        url: "/create_edit_order",
                        method: "POST",
                        data: {'order_id' : self.order_id, 'order_data' : self.order_data}
                    })
                    .then(function(response){
                        self.show_err = false;
                        self.loadSpinner = false;
                        var response_data = response.data;
                        commonUtility.displayErrorMsg(response_data["response"]);
                        $window.location.href = "/";
                    }, function(error_response) {
                        var response_data = error_response.data;
                        commonUtility.displayErrorMsg(response_data["response"]);
                        self.show_err = true;
                        self.loadSpinner = false;
                    });
                };

                self.getOrder();
            });
        </script>
    </head>
    <body style="padding-top:0px;">
        <section layout="row">
            <div flex layout="row" layout-align="center center">
                <div ng-controller="CreateEditOrder as ctrl" layout="column" ng-cloak style="width: -webkit-fill-available;">
                    <md-content layout-padding>
                        <section layout="row" layout-align="center center" layout-wrap>
                            <span class="no-border" flex="20"></span> 
                            <md-button class="md-primary md-raised" flex="20" href="/logout">[[ctrl.user]] - Logout</md-button>
                        </section>
                        <div layout="row" layout-sm="column" layout-align="space-around">
                            
                            <md-progress-circular layout="space-around" ng-show="ctrl.loadSpinner" class="md-hue-2" md-mode="indeterminate" md-diameter="40"></md-progress-circular>
                        </div>
	                        <md-content class="md-padding">
	                        <div flex-sm="100" flex-gt-sm="80" layout-align="center center">
	                            <form name="create_edit_order_form" method="post" ng-submit="submitForm()">
	                                {% csrf_token %}
                                    <div layout="row">
    	                                <md-input-container class="md-block" flex-gt-sm>
    	                                    <label>Client Name</label>
    	                                    <input required type="text" name="client_name" ng-model="ctrl.order_data.client_name">
    	                                    <div ng-messages = "create_edit_order_form.client_name.$error">
                         						<div ng-message = "required">This is required</div>
                      						</div>
    	                                </md-input-container>
                                        <md-input-container class="md-block" flex-gt-sm>
                                        <label>Challan Number</label>
                                        <input type="text" name="client_challan_number" required ng-model="ctrl.order_data.client_challan_number">
                                        <div ng-messages = "create_edit_order_form.client_challan_number.$error">
                                            <div ng-message = "required">This is required</div>
                                        </div>
                                        </md-input-container>
                                        <md-input-container>
                                            <div flex-gt-xs>
                                              <md-datepicker ng-model="ctrl.order_data.incoming_date" md-placeholder="Incoming date"></md-datepicker>
                                            </div>
                                        </md-input-container>
                                    </div>
                                    <div layout="row">
    							        <md-input-container class="md-block" flex-gt-sm>
    							            <label>Garment Type</label>
    							            <md-select name="garment_type" ng-model="ctrl.order_data.garment_type" required>
    							              	<md-option value="[[garment_type.id]]" ng-repeat="garment_type in garment_types">
    							              		[[garment_type.type_name]]
    							          		</md-option>
    							            </md-select>
    	                                    <div ng-messages = "create_edit_order_form.garment_type.$error">
                         						<div ng-message = "required">This is required</div>
                      						</div>							            
    							        </md-input-container>
    							        <md-input-container class="md-block" flex-gt-sm>
    							            <label>Garment Count</label>
    							            <input name="garment_count" ng-model="ctrl.order_data.garment_count"
    							                   required ng-pattern="/^[0-9]+$/">
    							            <div ng-messages="create_edit_order_form.garment_count.$error" role="alert" multiple>
    							              <div ng-message="required" class="my-message">This is required.</div>
    							              <div ng-message="pattern" class="my-message">That doesn't look like a valid count
    							              </div>
    							            </div>
    							        </md-input-container>
                                    </div>
                                    <div layout="row">
    							        <md-input-container class="md-block" flex-gt-sm>
    							            <label>Shoot Type</label>
    							            <md-select name="shoot_type" ng-model="ctrl.order_data.shoot_type" ng-change="ctrl.shootTypeChange()" required>
    							              	<md-option value="[[shoot_type.id]]" ng-repeat="shoot_type in shoot_types">
    							              		[[shoot_type.type_name]]
    							          		</md-option>
    							              </md-option>
    							            </md-select>
    	                                    <div ng-messages = "create_edit_order_form.shoot_type.$error">
                         						<div ng-message = "required">This is required</div>
                      						</div>							            
    							        </md-input-container>
    							        <md-input-container class="md-block" flex-gt-sm>
    							            <label>Shoot Sub Type</label>
    							            <md-select name="shoot_sub_type" ng-model="ctrl.order_data.shoot_sub_type" ng-required="ctrl.order_data.shoot_type == 4 || ctrl.order_data.shoot_type == 5" ng-disabled="!ctrl.order_data.shoot_type || shoot_sub_types.length === 0">
    							              	<md-option value="[[shoot_sub_type.id]]" ng-repeat="shoot_sub_type in shoot_sub_types">
    							              		[[shoot_sub_type.sub_type_name]]
    							          		</md-option>
    							              </md-option>
    							            </md-select>
    	                                    <div ng-messages = "create_edit_order_form.shoot_sub_type.$error">
                         						<div ng-message = "required">This is required</div>
                      						</div>							            
    							        </md-input-container>
                                    </div>
                                    <div layout="row">
    							        <md-input-container class="md-block" flex-gt-sm>
    							            <label>Work Type</label>
    							            <md-select name="work_type" ng-model="ctrl.order_data.work_type" ng-change="ctrl.workTypeChange()" required>
    							              	<md-option value="[[work_type.id]]" ng-repeat="work_type in work_types">
    							              		[[work_type.type_name]]
    							          		</md-option>
    							              </md-option>
    							            </md-select>
    	                                    <div ng-messages = "create_edit_order_form.work_type.$error">
                         						<div ng-message = "required">This is required</div>
                      						</div>							            
    							        </md-input-container>
    							        <md-input-container class="md-block" flex-gt-sm>
    							            <label>Size</label>
    							            <md-select name="work_sub_type" ng-model="ctrl.order_data.size" required ng-disabled="!ctrl.order_data.work_type">
    							              	<md-option value="[[work_sub_type.id]]" ng-repeat="work_sub_type in work_sub_types">
    							              		[[work_sub_type.sub_type_name]]
    							          		</md-option>
    							              </md-option>
    							            </md-select>
    	                                    <div ng-messages = "create_edit_order_form.work_sub_type.$error">
                         						<div ng-message = "required">This is required</div>
                      						</div>								            
    							        </md-input-container>
                                    </div>
                                    <div layout="row">
                                        <md-input-container class="md-block" flex-gt-sm>
                                            <label>Blouse Stitch</label>
                                            <md-select name="blouse_stitch" ng-model="ctrl.order_data.has_blouse_stitch" required>
                                                <md-option value="True">Yes</md-option>
                                                <md-option value="False">No</md-option>
                                              </md-option>
                                            </md-select>
                                            <div ng-messages = "create_edit_order_form.blouse_stitch.$error">
                                                <div ng-message = "required">This is required</div>
                                            </div>                                      
                                        </md-input-container>
                                        <md-input-container class="md-block" flex-gt-sm>
                                            <label>Photo Lamination</label>
                                            <md-select name="photo_lamination" ng-model="ctrl.order_data.has_photo_lamination" required>
                                                <md-option value="True">Yes</md-option>
                                                <md-option value="False">No</md-option>
                                              </md-option>
                                            </md-select>
                                            <div ng-messages = "create_edit_order_form.photo_lamination.$error">
                                                <div ng-message = "required">This is required</div>
                                            </div>                                      
                                        </md-input-container>
                                    </div>
                                    <div layout="row">
    							        <md-input-container class="md-block" flex-gt-sm>
    							            <label>Outer Page Quality</label>
    							            <md-select name="outer_page_quality" ng-model="ctrl.order_data.outer_page_quality" required>
    							              	<md-option value="[[page_quality.id]]" ng-repeat="page_quality in page_qualities">
    							              		[[page_quality.quality_name]]
    							          		</md-option>
    							              </md-option>
    							            </md-select>
    	                                    <div ng-messages = "create_edit_order_form.outer_page_quality.$error">
                         						<div ng-message = "required">This is required</div>
                      						</div>							            
    							        </md-input-container>
    							        <md-input-container class="md-block" flex-gt-sm>
    							            <label>Inner Page Quality</label>
    							            <md-select name="inner_page_quality" ng-model="ctrl.order_data.inner_page_quality" required>
    							              	<md-option value="[[page_quality.id]]" ng-repeat="page_quality in page_qualities">
    							              		[[page_quality.quality_name]]
    							          		</md-option>
    							              </md-option>
    							            </md-select>
    	                                    <div ng-messages = "create_edit_order_form.inner_page_quality.$error">
                         						<div ng-message = "required">This is required</div>
                      						</div>							            
    							        </md-input-container>
                                    </div>
                                    <div layout="row">
    							        <md-input-container class="md-block" flex-gt-sm>
    							            <label>Binding Type</label>
    							            <md-select name="binding_type" ng-model="ctrl.order_data.binding_type" required>
    							              	<md-option value="[[binding_type.id]]" ng-repeat="binding_type in binding_types">
    							              		[[binding_type.type_name]]
    							          		</md-option>
    							              </md-option>
    							            </md-select>
    	                                    <div ng-messages = "create_edit_order_form.binding_type.$error">
                         						<div ng-message = "required">This is required</div>
                      						</div>						            
    							        </md-input-container>
                                        <md-input-container class="md-block" flex-gt-sm>
                                            <label>Page Count</label>
                                            <input name="book_quantity" ng-model="ctrl.order_data.page_count"
                                                   required ng-pattern="/^[0-9]+$/">
                                            <div ng-messages="create_edit_order_form.page_count.$error" role="alert" multiple>
                                              <div ng-message="required" class="my-message">This is required.</div>
                                              <div ng-message="pattern" class="my-message">That doesn't look like a valid count
                                              </div>
                                            </div>
                                        </md-input-container>
                                    </div>
                                    <div layout="row">
    	                                <md-input-container class="md-block" flex-gt-sm>
    	                                    <label>Book Name</label>
    	                                    <input required type="text" name="book_name" ng-model="ctrl.order_data.book_name">
    	                                    <div ng-messages = "create_edit_order_form.book_name.$error">
                         						<div ng-message = "required">This is required</div>
                      						</div>
    	                                </md-input-container>
    							        <md-input-container class="md-block" flex-gt-sm>
    							            <label>Book Quantity</label>
    							            <input name="book_quantity" ng-model="ctrl.order_data.book_quantity"
    							                   required ng-pattern="/^[0-9]+$/">
    							            <div ng-messages="create_edit_order_form.book_quantity.$error" role="alert" multiple>
    							              <div ng-message="required" class="my-message">This is required.</div>
    							              <div ng-message="pattern" class="my-message">That doesn't look like a valid count
    							              </div>
    							            </div>
    							        </md-input-container>
                                    </div>
	                                <md-button class="md-raised md-warn pull-right" style="width:30%;" type="submit">Save</md-button>
	                            </form>
	                        </div>
	                    </md-content>
                    </md-content>
                </div>
            </div>
        </section>
    </body>
</html>