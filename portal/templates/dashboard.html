{% load staticfiles %}
<!DOCTYPE html>
<html ng-app="Dashboard" lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="shortcut icon" href="{% static "img/favicon.png" %}">
        <title>Dashboard | Prometheus</title>
        <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.1/angular-material.min.css">
        <link rel="stylesheet" href="{% static "css/dashboard.css" %}" type = "text/css">
        <link rel="stylesheet" href="{% static "css/v-accordion.css" %}" type = "text/css">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
        <script type="text/javascript" src = "{% static "js/angular.min.js" %}"></script>
        <script type="text/javascript" src = "{% static "js/angular-animate.js" %}"></script>
        <script type="text/javascript" src = "{% static "js/angular-spinner.min.js" %}"></script>
        <script type="text/javascript" src = "{% static "js/spin.min.js" %}"></script>
        <script type="text/javascript" src = "{% static "js/v-accordion.js" %}"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular-aria.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/angular_material/0.11.1/angular-material.min.js"></script>

        <script type="text/javascript" src = "{% static "js/utility.js" %}"></script>
        <script type="text/ng-template" id="dialogs/shoot_dialog.html"></script>

        <style type="text/css">
            hr {
                margin-bottom: 5px;
                margin-top: 5px;
            }
            .flex.layout.layout-row {
                padding-bottom: 3px;
            }
            span.flex {
                font-size: large;
                text-align: center;
                border: black;
                border-width: thin;
                border-style: solid;
                align-items: center;
                justify-content: center;
                display: flex;
            }
            button span {
                border-style: none;
            }
            span.no-border {
                border-style: none;
                font-size: 13px;
            }
            section.section {
                padding-top:20px;
                padding-left:20px;
                padding-right:20px;
            }
            div.zones {
                /*padding: 10px;*/
                text-align: inherit;
            }
            span.green {
                background-color: #87e087;
            }
            span.orange {
                background-color: #efaa52;
            }
            span.light_red {
                background-color: #ff8181;
            }
            span.flash_red {
                background-color: #a50000;
                color: antiquewhite;
            }
            .defaultcase {
                text-transform: none;
            }
        </style>

        <script type="text/javascript">
            var app = angular.module('Dashboard',['ngMaterial', 'vAccordion', 'ngAnimate', 'shared']).value('ops_user', '{{ops_user}}');
            app.config(['$httpProvider', function($httpProvider) {
                $httpProvider.defaults.xsrfCookieName = 'csrftoken';
                $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
            }])
            .config(['$interpolateProvider', function($interpolateProvider) {
			    $interpolateProvider.startSymbol('[[');
			    $interpolateProvider.endSymbol(']]');
			}])
            .config(['$mdIconProvider', function($mdIconProvider) {
                $mdIconProvider
                   .iconSet('person', 'img/person_pin.svg', 24)
                   .defaultIconSet('img/person_pin.svg', 24);
            }])

            app.controller('DashboardCtrl', function DashboardCtrl ($scope, $timeout, $q, $http, $window, $mdDialog, $interval, commonUtility, ops_user) {
                var self = this;

                self.timer = 0;
                self.show_err = false;

                self.user = ops_user;

                self.loadSpinner = false;

                self.redirectToOrderPage = function(order_id) {
                    if (order_id && order_id !== '') {
                        $window.location.href = "/create_edit_order?order_id=" + order_id;
                    } else {
                        $window.location.href = "/create_edit_order";
                    }
                };

                self.loadOrderData = function() {

                	self.loadSpinner = true;
                	self.order_data = [];
                    self.message = "";
                    
                    $http({
                        url: "/dashboard/order_data",
                        method: "GET"
                    })
                    .then(function(response){
                        self.show_err = false;
                    	self.loadSpinner = false;
                        var response_data = response.data;
                        self.order_data = response_data["order_data"];
                    }, function(error_response) {
                        var response_data = error_response.data;
                        commonUtility.displayErrorMsg(response_data["message"]);
                        self.show_err = true;
                        self.loadSpinner = false;
                    });
                };

                self.loadOrderData();

                self.moveToNextStage = function(event, order_id, next_status, has_next_status_form) {
                    //get dialog data only for shooting, cutting and printing status since only they have data to be pre-populated
                    self.next_status = next_status;
                    if ([2,3,6,7,16,17].includes(next_status)) {
                        $http({
                            url: '/get_dialog_data?next_status=' + String(next_status) + '&order_id=' + order_id,
                            method: "GET"
                        })
                        .then(function(response){
                            self.dialog_data = response.data['dialog_data'];
                            self.openDialog(event, order_id, next_status);
                        }, function(error_response) {
                            var response_data = error_response.data;
                            commonUtility.displayErrorMsg(response_data["message"]);
                        });
                    } else {
                        self.openDialog(event, order_id, next_status);
                    }
                };

                self.openDialog = function(event, order_id, next_status) {
                    $mdDialog.show({
                        controller: DialogController,
                        templateUrl: 'render_dialog?next_status=' + String(next_status) + '&order_id=' + order_id,
                        parent: angular.element(document.body),
                        targetEvent: event,
                        clickOutsideToClose:true,
                        controllerAs: 'ctrl',
                        locals: {data: {'next_status': next_status, 'dialog_data': self.dialog_data}}
                    })
                    .then(function(answer) {
                        $scope.status = 'You said the information was "' + answer + '".';
                    }, function() {
                        $scope.status = 'You cancelled the dialog.';
                    });
                }

                // self.hide = function() {
                //     $mdDialog.hide();
                // };
                // self.cancel = function() {
                //     $mdDialog.cancel();
                // };
                // self.save = function(answer) {
                //     console.log(self.next_status);
                //     console.log(data.next_status);
                //     $mdDialog.hide(answer);
                // };
            });

            // // Code begins for dialogs
            function DialogController($scope, $mdDialog, data) {
                $scope.data = data;
                $scope.hide = function() {
                    $mdDialog.hide();
                };
                $scope.cancel = function() {
                    $mdDialog.cancel();
                };
                $scope.save = function(answer) {
                    console.log(data.next_status);
                    console.log(data);
                    $mdDialog.hide(answer);
                };
            }
        </script>
    </head>
    <body style="padding-top:0px;">
        <section layout="row">
            <div flex layout="row" layout-align="center center">
                <div ng-controller="DashboardCtrl as ctrl" layout="column" ng-cloak style="width: -webkit-fill-available;">
                    <md-content class="md-padding">
                        <section layout="row" layout-align="space-between start" layout-wrap>
                            <md-button class="md-primary" flex="20" ng-click="ctrl.redirectToOrderPage('')">
                                Create new order
                            </md-button>
                            <span class="no-border" flex="20"></span> 
                            <md-button class="md-primary" flex="20" href="/logout">[[ctrl.user]] - Logout</md-button>
                        </section>
                        <table align="center" id="dashTable">
                            <thead>
                                <th>Client</th>
                                <th>Date</th>   
                                <th>Challan Number</th>   
                                <th>Garment Type</th>
                                <th>Work Type</th>
                                <th>Status</th>
                                <th>Action</th>
                            </thead>
                            <h2 ng-show="ctrl.show_err" style="text-align: center;">
                                [[ctrl.message]]
                            </h2>
                            <md-progress-circular ng-hide="ctrl.show_err" layout="column" ng-show="ctrl.loadSpinner" class="md-warn md-hue-3" md-diameter="40"></md-progress-circular>
                            <tbody>
                                <tr ng-repeat="order in ctrl.order_data" class="zones">
                                    <td>[[order.client_name]]</td>
                                    <td>[[order.incoming_date]]</td>
                                    <td>[[order.client_challan_number]]</td>   
                                    <td>[[order.garment_type]]</td>
                                    <td>[[order.work_type]]</td>
                                    <td>[[order.status]]</td>
                                    <td>
                                        <md-button class="defaultcase md-primary" layout="column" layout-align="start center" ng-click="ctrl.moveToNextStage($event, order.id, order.next_status.value, has_next_status_form)">[[order.next_status.name]]</md-button>
                                        <md-button class="defaultcase md-primary" layout="column" layout-align="end center" ng-click="ctrl.redirectToOrderPage(order.id)">Update</md-button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </md-content>
                </div>
            </div>
        </section>
    </body>
</html>